<% rake_command = (@bundler ? "bundle exec rake" : "/usr/bin/rake") %>
Bluepill.application("<%= @app %>_resque", :log_file => "/var/log/bluepill.log") do |app|
  app.uid = "<%= @owner %>"
  app.gid = "<%= @group %>"
  
  <% @envs.each_with_index do |env, index| %>
    app.process("<%= @app %>_workers_<%= index %>") do |process|
      process.group = "resque"
      process.pid_file = "<%= @pids_path %>/livrenoir_workers_<%= index %>.pid"
      process.working_dir = "<%= @path %>/current"
      process.start_command = "cd <%= @path %>/current && <%= env %> <%= rake_command %> environment resque:workers"
      process.stop_command = "kill -QUIT {{PID}}; echo {{PID}}"
      process.start_grace_time = 5.seconds
      process.stop_grace_time = 75.seconds
      process.restart_grace_time = 80.seconds
      process.daemonize = true

      process.checks :mem_usage, :below => <%= @memory_limit %>, :every => <%= @check_every %>, :times => <%= @restart_after %>
    end
  <% end %>
end
